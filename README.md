# PhpForHealthAPI

Disclaimer: This project is not affiliated with Withings by any means.

## Summary
PhpForHealthAPI is a php helper class created to simplify the access to the [Withings' API](http://oauth.withings.com/api).  
While the dance to get OAuth working may be complicated, this class wraps up all the complexity and exposes simple functions to query the API.  

The class consist on a single file that can be easily included in any project.

## Table of contents
+ [The repository](#the-repository)
+ [How to install](#how-to-install)
+ [OAuth authentication process](#oauth-authentication-process)
+ [Demo](#demo)
+ [The functions](#the-functions)
+ [Feedback and issues](#feedback-and-issues)
+ [License](#license)

## The repository

All you need in your project is the PhpForHealthApi.class.php file at the root of the repository. Simply include this class and you are good to go.

To help you understand how you can use it, we created a demo folder containing some php scripts used in the [demo](#demo) part of this readme.

## How to install

The installation is really simple, drop PhpForHealthApi.class.php in the directory of your choice. Include it in your script and intanciate the said class.

```php
// Including the class
require_once('PATH_TO_DIRECTORY/PhpForHealthApi.class.php');

// Create an instance
$phpForHealthApi = new PhpForHealthApi(CONSUMER_KEY, CONSUMER_SECRET, ACCESS_TOKEN, ACCESS_TOKEN_SECRET);
```

## OAuth authentication process

[OAuth](http://oauth.net/) is a popular protocol to securize API. However, it requires a strict process to be granted the access to resources.
Fortunately, the class handles all the heavy lifting leaving you with a few simple steps.

Here is what you have to do:
* You have to register on hte withings website as a developer. You will then be given a consumer key and a consumer secret.
* Your application has to send a query to get a request token.
* The server responds with a request token and a request token secret that you use to redirect the user to a login page.
* Once authenticated, the user is redirected to a callback URL managed by your application where you can collect the access token and access token secret.

Still confused? Don't worry the demo will clear that up for you.

## Demo

This demo will show you how to proceed to get the OAuth token and to perform queries.

Before starting the demo, you have to get a comsumer key and a consumer secret, you can do so by registering at the following address : [Withings for developers](https://oauth.withings.com/partner/add)

Once those two pieces of information in hand we can start playing with the code.
In the demo folder you will find 4 files:

1.  FileStorer.class.php > This is a class that will help us storing our credentials. We strongly recommend you to use something mode secure in production.
2.  getRequestToken.php > This script will ask the API server a request token. Once the token fetched, the script redirects the user to login page.
3.  getAccessToken.php > The user is supposed to be redirected to this page once successfully logged in with the access token + secret as payload. The script saves them.
4.  getMeasureActivity.php > This script demonstrates how to perform a query to the API.

Let's start by replacing the values in each files to match your configuration
Open getRequestToken.php and replace the values by yours:
```php
// Variables to edit
$consumerKey = YOUR_CONSUMER_KEY;
$consumerSecret = YOUR_CONSUMER_SECRET;
$callbackUrl = YOUR_CALLBACK_URL; // ex:'http://domainname/getAccessToken.php'
```

The callback url must point to the getAccessToken.php file

Do the same in getAccessToken.php and getMeasureActivity.php:
```php
// Variables to edit
$consumerKey = YOUR_CONSUMER_KEY;
$consumerSecret = YOUR_CONSUMER_SECRET;
```
Once everything replaced, it's time to communicate with the API server.

Open getRequestToken.php in your browser, the script will ask a request token and a request token secret to the API, once fetched, it saves them to a file and redirect to a login page whose URL is generated by generateAuthorizationUrl().  
Log in using your credentials and grant access to your app. You will then be redirected to getAccesstoken.php (the callback URL) which will saves the access token and the access token secret sent by the API as URL parameters.

You should see the following information:

> Credentials:  
> User Id : USER_ID  
> Access Token : ACCESS_TOKEN  
> Access Token Secret : ACCESS_TOKEN_SECRET  

That's it, you have now the access token and the associated secret. Let's make our first data request by calling getMeasureActivity.php

> {"status":0,"body":{}}

Congratulations, you just made your first API call!

## The functions

The function are made to be as close as possible to the API.

The names are built by following this rule:  
method + Category + Action  
ex : GET + Measure + Activity = getMeasureActivity
_Note : action is sometimes shortened_

__If a parameter is optional, pass a -1 to omit it__

Here are the "prototypes":

```php
/**
 * Get Activity Measurements
 * 
 * @param userid
 * 		User id
 * @param date
 * 		(optional) Date YYYY-mm-dd
 * @param startdateymd
 * 		(optional) Start date YYYY-mm-dd
 * @param enddateymd
 * 		(optional) End date YYYY-mm-dd
 * 
 * @return Request result
 */
public function getMeasureActivity($userid, $date = -1, $startdateymd = -1, $enddateymd = -1)
```

```php
/**
 * Get Body Measurements
 * 
 * @param userid
 * 		User id
 * @param startdateymd
 * 		(optional) Start date as timestamp
 * @param enddateymd
 * 		(optional) End date as timestamp
 * @param lastupdate
 * 		(optional) Since Date as timestamp
 * 					1 => Weight (kg)
 * 					4 => Height (meter)
 * 					5 => Fat Free Mass (kg)
 * 					6 => Fat Ratio (%)
 * 					8 => Fat Mass Weight (kg)
 * 					9 => Diastolic Blood Pressure (mmHg)
 * 					10 => Systolic Blood Pressure (mmHg)
 * 					11 => Heart Pulse (bpm)
 * 					54 => SP02 (%)
 * @param meastype
 * 		(optional) Type of measurements filter
 * @param category
 * 		(optional) Category (1 => measurements | 2 => objectives)
 * @param limit
 * 		(optional) Maximum number of measurements to return
 * @param offset
 * 		(optional) Skip offset
 * 
 * @return Request result
 */
public function getMeasureBody($userid, $startdate = -1, $enddate = -1, $lastupdate = -1, $meastype = -1, $category = -1, $limit = -1, $offset = -1)
```

```php
/**
 * Get Intraday Activity Measurements
 * 
 * @param userid
 * 		User id
 * @param startdate
 * 		Start date as timestamp
 * @param enddate
 * 		End date as timestamp
 * 
 * @return Request result
 */
public function getMeasureIntraday($userid, $startdate, $enddate)
```

```php
/**
 * Get Sleep Measurements
 * 
 * @param userid
 * 		User id
 * @param startdate
 * 		Start date as timestamp
 * @param enddate
 * 		End date as timestamp
 * 
 * @return Request result
 */
public function getMeasureSleep($userid, $startdate, $enddate)
```

```php
/**
 * Get Sleep Summary
 * 
 * @param userid
 * 		User id
 * @param startdate
 * 		Start date as timestamp
 * @param enddate
 * 		End date as timestamp
 * 
 * @return Request result
 */
public function getMeasureSleepSummary($userid, $startdate, $enddate)
```

```php
/**
 * Create a notification
 * 
 * @param userid
 * 		User id
 * @param callbackurl
 * 		Callback URL
 * @param comment
 * 		Comment shown to user
 * @param appli
 * 		(optional) Application
 * 					1 => Body Scale
 * 					4 => Blood pressure monitor
 * 					16 => Withings pulse
 * 					44 => Sleep monitor
 * 
 * @return Request result
 */
public function getNotificationSuscribe($userid, $callbackurl, $comment, $appli = -1)
```

```php
/**
 * Get a notification
 * 
 * @param userid
 * 		User id
 * @param callbackurl
 * 		Callback URL
 * @param appli
 * 		(optional) Application
 * 					1 => Body Scale
 * 					4 => Blood pressure monitor
 * 					16 => Withings pulse
 * 					44 => Sleep monitor
 * 
 * @return Request result
 */
public function getNotification($userid, $callbackurl, $appli = -1)
```

```php
/**
 * Get notification list
 * 
 * @param userid
 * 		User id
 * @param appli
 * 		(optional) Application
 * 					1 => Body Scale
 * 					4 => Blood pressure monitor
 * 					16 => Withings pulse
 * 					44 => Sleep monitor
 * 
 * @return Request result
 */
public function getNotificationList($userid, $appli = -1)
```

```php
/**
 * Revoke a notification
 * 
 * @param userid
 * 		User id
 * @param callbackurl
 * 		Callback URL
 * @param appli
 * 		(optional) Application
 * 					1 => Body Scale
 * 					4 => Blood pressure monitor
 * 					16 => Withings pulse
 * 					44 => Sleep monitor
 * 
 * @return Request result
 */
public function getNotificationRevoke($userid, $callbackurl, $appli = -1)
```

## Feedback and issues
Feel free to send feedback, open issues, submit feature requests or pull requests

## License
This project is distributed under the GNU AFFERO GENERAL PUBLIC LICENSE V3. Refer to the LICENSE file for more information.
